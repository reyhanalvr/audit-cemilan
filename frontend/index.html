<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audit Penjualan</title>
  <link rel="icon" type="image/png" href="assets/logo.jpg">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .sort-indicator {
      display: inline-block;
      transition: transform 0.2s;
    }
    th[data-sort="asc"] .sort-indicator::after {
      content: '⬍';
    }
    th[data-sort="desc"] .sort-indicator::after {
      content: '⬆';
    }
    .limit-btn {
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      transition: all 0.2s;
    }
    .limit-btn.active {
      background-color: #3b82f6;
      color: white;
      font-weight: 600;
    }
    .limit-btn:not(.active) {
      background-color: #e5e7eb;
      color: #374151;
    }
    .limit-btn:hover:not(.active) {
      background-color: #d1d5db;
    }
    .chart-container {
      transition: all 0.3s ease;
    }
    .chart-container.minimized .chart-content {
      display: none;
    }
    .chart-container .toggle-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      background-color: #3b82f6;
      color: white;
      font-size: 0.875rem;
      cursor: pointer;
    }
    .chart-container.minimized .toggle-btn {
      background-color: #10b981;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <!-- Navigasi -->
  <nav class="bg-blue-500 p-4">
    <div class="container mx-auto flex flex-col sm:flex-row justify-between items-start sm:items-center">
      <div class="text-white text-lg font-semibold mb-2 sm:mb-0">Manajemen Penjualan</div>
      <div class="space-x-0 space-y-2 sm:space-x-4 sm:space-y-0 flex flex-col sm:flex-row">
        <a href="index.html" class="text-white hover:underline">Penjualan</a>
        <a href="stock.html" class="text-white hover:underline">Stok Barang</a>
        <a href="production.html" class="text-white hover:underline">Catatan Produksi</a>
        <a href="profit.html" class="text-white hover:underline">Laporan Keuangan</a>
      </div>
    </div>
  </nav>

  <div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold text-center mb-6">Audit Penjualan Website</h1>
    
    <!-- Formulir Input -->
    <div class="bg-white p-6 mb-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-4">Tambah Data Penjualan</h2>
      <form id="salesForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label for="date" class="block mb-1">Tanggal</label>
          <input type="date" id="date" class="w-full border p-2 rounded" required>
        </div>
        <div>
          <label for="saleType" class="block mb-1">Tipe Penjualan</label>
          <select id="saleType" class="w-full border p-2 rounded" required>
            <option value="onhand">On Hand</option>
            <option value="reseller">Reseller</option>
          </select>
        </div>
        <div>
          <label for="product" class="block mb-1">Produk</label>
          <select id="product" class="w-full border p-2 rounded" required>
            <option value="" disabled selected>Pilih produk</option>
            <option value="Basreng 100Gr" data-price="10000" data-reseller="9000">Basreng 100Gr</option>
            <option value="Basreng 200Gr" data-price="15500" data-reseller="14500">Basreng 200Gr</option>
            <option value="Makaroni 100Gr" data-price="10000" data-reseller="9000">Makaroni 100Gr</option>
            <option value="Makaroni 200Gr" data-price="13000" data-reseller="12000">Makaroni 200Gr</option>
            <option value="Keripik Kaca 50Gr" data-price="8000" data-reseller="7000">Keripik Kaca 50Gr</option>
            <option value="Kripik Kaca 110Gr" data-price="12000" data-reseller="11000">Kripik Kaca 110Gr</option>
            <option value="Singkong 100Gr" data-price="10000" data-reseller="9000">Singkong 100Gr</option>
          </select>
        </div>
        <div>
          <label for="branch" class="block mb-1">Cabang</label>
          <select id="branch" class="w-full border p-2 rounded" required>
            <option value="" disabled selected>Pilih cabang</option>
            <option value="Jablay 1 (Zhidan)">Jablay 1 (Zhidan)</option>
            <option value="Jablay 2 (Reyhan)">Jablay 2 (Reyhan)</option>
            <option value="Jablay 3 (Tangsel)">Jablay 3 (Tangsel)</option>
          </select>
        </div>
        <div>
          <label for="unitPrice" class="block mb-1">Harga Satuan (Rp)</label>
          <input type="number" id="unitPrice" class="w-full border p-2 rounded bg-gray-100" readonly required>
        </div>
        <div>
          <label for="quantity" class="block mb-1">Jumlah</label>
          <input type="number" id="quantity" class="w-full border p-2 rounded" min="1" placeholder="Masukkan jumlah" required>
        </div>
        <div>
          <label for="paymentMethod" class="block mb-1">Metode Pembayaran</label>
          <select id="paymentMethod" class="w-full border p-2 rounded" required>
            <option value="Transfer Bank">Transfer Bank</option>
            <option value="Cash">Cash</option>
          </select>
        </div>
        <div>
          <label for="paymentStatus" class="block mb-1">Status Pembayaran</label>
          <select id="paymentStatus" class="w-full border p-2 rounded" required>
            <option value="Lunas">Lunas</option>
            <option value="Belum Lunas">Belum Lunas</option>
          </select>
        </div>
        <div class="sm:col-span-3">
          <label for="description" class="block mb-1">Deskripsi</label>
          <textarea id="description" class="w-full border p-2 rounded" rows="3" placeholder="Masukkan deskripsi (opsional)"></textarea>
        </div>
        <div class="sm:col-span-3">
          <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tambah Penjualan</button>
        </div>
      </form>
    </div>
    
    <!-- Filter -->
    <div class="mb-4 flex flex-col sm:flex-row gap-4 flex-wrap">
      <div>
        <label for="startDate" class="mr-2">Tanggal Mulai:</label>
        <input type="date" id="startDate" class="border p-2 rounded">
      </div>
      <div>
        <label for="endDate" class="mr-2">Tanggal Akhir:</label>
        <input type="date" id="endDate" class="border p-2 rounded">
      </div>
      <div>
        <label for="search" class="mr-2">Cari ID Transaksi:</label>
        <input type="text" id="search" class="border p-2 rounded" placeholder="Masukkan ID Transaksi">
      </div>
      <div>
        <label for="paymentStatusFilter" class="mr-2">Filter Status Pembayaran:</label>
        <select id="paymentStatusFilter" class="border p-2 rounded">
          <option value="all">Semua</option>
          <option value="Lunas">Lunas</option>
          <option value="Belum Lunas">Belum Lunas</option>
        </select>
      </div>
      <div>
        <label for="branchFilter" class="mr-2">Filter Cabang:</label>
        <select id="branchFilter" class="border p-2 rounded">
          <option value="all">Semua Cabang</option>
          <option value="Jablay 1 (Zhidan)">Jablay 1 (Zhidan)</option>
          <option value="Jablay 2 (Reyhan)">Jablay 2 (Reyhan)</option>
          <option value="Jablay 3 (Tangsel)">Jablay 3 (Tangsel)</option>
        </select>
      </div>
      <div class="flex items-center gap-2">
        <span class="mr-2">Tampilkan:</span>
        <button class="limit-btn active" data-limit="10">10</button>
        <button class="limit-btn" data-limit="50">50</button>
        <button class="limit-btn" data-limit="100">100</button>
        <button class="limit-btn" data-limit="all">Last Transaction</button>
      </div>
      <div>
        <button id="exportCSV" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Ekspor ke CSV</button>
        <button id="resetFilter" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Reset Filter</button>
      </div>
    </div>
    
    <!-- Grafik Penjualan Harian (Bar Chart) -->
    <div class="chart-container minimized bg-white p-6 mb-6 rounded-lg shadow-md relative" id="salesChartContainer">
      <h2 class="text-xl font-semibold mb-4">Grafik Penjualan Harian</h2>
      <button class="toggle-btn" id="toggleSalesChart">+</button>
      <div class="chart-content">
        <canvas id="salesChart" class="w-full h-64"></canvas>
      </div>
    </div>

    <!-- Grafik Barang Keluar (Line Chart) -->
    <div class="chart-container minimized bg-white p-6 mb-6 rounded-lg shadow-md relative" id="quantityChartContainer">
      <h2 class="text-xl font-semibold mb-4">Grafik Total Barang Keluar</h2>
      <button class="toggle-btn" id="toggleQuantityChart">+</button>
      <div class="chart-content">
        <canvas id="quantityChart" class="w-full h-64"></canvas>
      </div>
    </div>
    
    <!-- Tabel Penjualan -->
    <div class="overflow-x-auto w-full">
      <table class="min-w-[700px] w-full bg-white shadow-md rounded-lg">
        <thead>
          <tr class="bg-gray-200 text-left">
            <th class="p-3 cursor-pointer" data-column="date" data-sort="asc">
              Tanggal
              <span class="sort-indicator ml-1">⬍</span>
            </th>
            <th class="p-3 cursor-pointer" data-column="id" data-sort="asc">
              ID Transaksi
              <span class="sort-indicator ml-1">⬍</span>
            </th>
            <th class="p-3 cursor-pointer" data-column="product" data-sort="asc">
              Produk
              <span class="sort-indicator ml-1">⬍</span>
            </th>
            <th class="p-3 cursor-pointer" data-column="branch" data-sort="asc">
              Cabang
              <span class="sort-indicator ml-1">⬍</span>
            </th>
            <th class="p-3 cursor-pointer" data-column="quantity" data-sort="asc">
              Jumlah
              <span class="sort-indicator ml-1">⬍</span>
            </th>
            <th class="p-3 cursor-pointer" data-column="unitPrice" data-sort="asc">
              Harga Satuan
              <span class="sort-indicator ml-1">⬍</span>
            </th>
            <th class="p-3 cursor-pointer" data-column="total" data-sort="asc">
              Total
              <span class="sort-indicator ml-1">⬍</span>
            </th>
            <th class="p-3 cursor-pointer" data-column="paymentMethod" data-sort="asc">
              Metode Pembayaran
              <span class="sort-indicator ml-1">⬍</span>
            </th>
            <th class="p-3 cursor-pointer" data-column="status" data-sort="asc">
              Status
              <span class="sort-indicator ml-1">⬽</span>
            </th>
            <th class="p-3 cursor-pointer" data-column="saleType" data-sort="asc">
              Tipe Penjualan
              <span class="sort-indicator ml-1">⬽</span>
            </th>
            <th class="p-3 cursor-pointer" data-column="paymentStatus" data-sort="asc">
              Status Pembayaran
              <span class="sort-indicator ml-1">⬽</span>
            </th>
            <th class="p-3">Aksi</th>
          </tr>
        </thead>
        <tbody id="salesTableBody"></tbody>
      </table>
      <p id="noDataMessage" class="text-red-600 text-center mt-2 hidden">Tidak ada transaksi pada rentang tanggal ini</p>
    </div>
    
    <!-- Ringkasan -->
    <div class="mt-6 bg-white p-4 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold">Ringkasan</h2>
      <div class="flex justify-between">
        <div>
          <p id="totalSales" class="mt-2">Total Penjualan: Rp0</p>
          <p id="totalPaid" class="mt-2">Total Lunas: Rp0</p>
          <p id="totalUnpaid" class="mt-2">Total Belum Lunas: Rp0</p>
        </div>
        <div class="text-right">
          <p id="totalATM" class="mt-2">Total Uang di ATM: Rp0</p>
          <p id="totalCash" class="mt-2">Total Uang di Cash: Rp0</p>
        </div>
      </div>
      <p id="anomaly" class="mt-2 text-red-600"></p>
    </div>
  </div>

  <!-- Modal untuk Edit -->
  <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white p-4 sm:p-6 rounded-lg w-full max-w-lg max-h-screen overflow-y-auto shadow-lg relative">
      <div class="absolute top-4 right-4 flex gap-2">
        <button type="button" id="cancelEdit" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm sm:text-base">Batal</button>
        <button type="submit" form="editForm" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm sm:text-base">Simpan</button>
      </div>
      <h2 class="text-xl font-semibold mb-4 text-center">Edit Transaksi</h2>
      <form id="editForm" class="space-y-3">
        <input type="hidden" id="editId">
        <div class="grid grid-cols-1 gap-3">
          <div>
            <label for="editDate" class="block mb-1 text-sm sm:text-base">Tanggal</label>
            <input type="date" id="editDate" class="w-full border p-2 rounded text-sm sm:text-base" required>
          </div>
          <div>
            <label for="editSaleType" class="block mb-1 text-sm sm:text-base">Tipe Penjualan</label>
            <select id="editSaleType" class="w-full border p-2 rounded text-sm sm:text-base" required>
              <option value="onhand">On Hand</option>
              <option value="reseller">Reseller</option>
            </select>
          </div>
          <div>
            <label for="editProduct" class="block mb-1 text-sm sm:text-base">Produk</label>
            <select id="editProduct" class="w-full border p-2 rounded text-sm sm:text-base" required>
              <option value="Basreng 100Gr" data-price="10000" data-reseller="9000">Basreng 100Gr</option>
              <option value="Basreng 200Gr" data-price="15500" data-reseller="14500">Basreng 200Gr</option>
              <option value="Makaroni 100Gr" data-price="10000" data-reseller="9000">Makaroni 100Gr</option>
              <option value="Makaroni 200Gr" data-price="13000" data-reseller="12000">Makaroni 200Gr</option>
              <option value="Keripik Kaca 50Gr" data-price="8000" data-reseller="7000">Keripik Kaca 50Gr</option>
              <option value="Kripik Kaca 110Gr" data-price="12000" data-reseller="11000">Kripik Kaca 110Gr</option>
              <option value="Singkong 100Gr" data-price="10000" data-reseller="9000">Singkong 100Gr</option>
            </select>
          </div>
          <div>
            <label for="editBranch" class="block mb-1 text-sm sm:text-base">Cabang</label>
            <select id="editBranch" class="w-full border p-2 rounded text-sm sm:text-base" required>
              <option value="Jablay 1 (Zhidan)">Jablay 1 (Zhidan)</option>
              <option value="Jablay 2 (Reyhan)">Jablay 2 (Reyhan)</option>
              <option value="Jablay 3 (Tangsel)">Jablay 3 (Tangsel)</option>
            </select>
          </div>
          <div>
            <label for="editQuantity" class="block mb-1 text-sm sm:text-base">Jumlah</label>
            <input type="number" id="editQuantity" class="w-full border p-2 rounded text-sm sm:text-base" min="1" required>
          </div>
          <div>
            <label for="editUnitPrice" class="block mb-1 text-sm sm:text-base">Harga Satuan (Rp)</label>
            <input type="number" id="editUnitPrice" class="w-full border p-2 rounded text-sm sm:text-base bg-gray-100" readonly required>
          </div>
          <div>
            <label for="editPaymentMethod" class="block mb-1 text-sm sm:text-base">Metode Pembayaran</label>
            <select id="editPaymentMethod" class="w-full border p-2 rounded text-sm sm:text-base" required>
              <option value="Transfer Bank">Transfer Bank</option>
              <option value="Cash">Cash</option>
            </select>
          </div>
          <div>
            <label for="editStatus" class="block mb-1 text-sm sm:text-base">Status</label>
            <select id="editStatus" class="w-full border p-2 rounded text-sm sm:text-base" required>
              <option value="Selesai">Selesai</option>
              <option value="Dikembalikan">Dikembalikan</option>
            </select>
          </div>
          <div>
            <label for="editPaymentStatus" class="block mb-1 text-sm sm:text-base">Status Pembayaran</label>
            <select id="editPaymentStatus" class="w-full border p-2 rounded text-sm sm:text-base" required>
              <option value="Lunas">Lunas</option>
              <option value="Belum Lunas">Belum Lunas</option>
            </select>
          </div>
          <div>
            <label for="editDescription" class="block mb-1 text-sm sm:text-base">Deskripsi</label>
            <textarea id="editDescription" class="w-full border p-2 rounded text-sm sm:text-base" rows="3" placeholder="Masukkan deskripsi (opsional)"></textarea>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    // State untuk melacak kolom dan arah sorting
    let currentSortColumn = 'date';
    let currentSortDirection = 'asc';
    // State untuk melacak jumlah transaksi yang ditampilkan
    let currentLimit = 10;
    // State untuk melacak status minimalkan grafik
    let isSalesChartMinimized = true;
    let isQuantityChartMinimized = true;

    // Fungsi untuk mengatur tombol limit aktif
    function setActiveLimitButton(limit) {
      document.querySelectorAll('.limit-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.limit === limit.toString() || (limit === 'all' && btn.dataset.limit === 'all')) {
          btn.classList.add('active');
        }
      });
    }

    // Fungsi untuk mengurutkan data
    function sortData(data, column, direction) {
      const sortedData = [...data];

      sortedData.sort((a, b) => {
        let valueA, valueB;

        switch (column) {
          case 'date':
            valueA = new Date(a.date);
            valueB = new Date(b.date);
            break;
          case 'id':
            valueA = a.id.toLowerCase();
            valueB = b.id.toLowerCase();
            break;
          case 'product':
            valueA = a.product.toLowerCase();
            valueB = b.product.toLowerCase();
            break;
          case 'branch':
            valueA = a.branch.toLowerCase();
            valueB = b.branch.toLowerCase();
            break;
          case 'quantity':
            valueA = a.quantity;
            valueB = b.quantity;
            break;
          case 'unitPrice':
            valueA = a.unitPrice;
            valueB = b.unitPrice;
            break;
          case 'total':
            valueA = a.total;
            valueB = b.total;
            break;
          case 'paymentMethod':
            valueA = a.paymentMethod.toLowerCase();
            valueB = b.paymentMethod.toLowerCase();
            break;
          case 'status':
            valueA = a.status.toLowerCase();
            valueB = b.status.toLowerCase();
            break;
          case 'saleType':
            valueA = (a.saleType || 'Tidak Diketahui').toLowerCase();
            valueB = (b.saleType || 'Tidak Diketahui').toLowerCase();
            break;
          case 'paymentStatus':
            valueA = a.paymentStatus === 'Belum Lunas' ? 0 : 1;
            valueB = b.paymentStatus === 'Belum Lunas' ? 0 : 1;
            break;
          default:
            return 0;
        }

        if (direction === 'asc') {
          return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
        } else {
          return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
        }
      });

      return sortedData;
    }

    let salesChart;
    let quantityChart;

    // Buat elemen tooltip secara global sebelum chart diinisialisasi
    const tooltipEl = document.createElement('div');
    tooltipEl.id = 'chartjs-tooltip';
    tooltipEl.style.background = 'rgba(0, 0, 0, 0.7)';
    tooltipEl.style.borderRadius = '3px';
    tooltipEl.style.color = 'white';
    tooltipEl.style.opacity = '0';
    tooltipEl.style.pointerEvents = 'none';
    tooltipEl.style.position = 'absolute';
    tooltipEl.style.transform = 'translate(-50%, 0)';
    tooltipEl.style.transition = 'all .1s ease';
    tooltipEl.style.padding = '5px 10px';
    tooltipEl.style.zIndex = '9999';
    tooltipEl.style.maxWidth = '300px';
    tooltipEl.style.whiteSpace = 'normal';
    document.body.appendChild(tooltipEl);

    // Fungsi untuk format Rupiah
    function formatRupiah(number) {
      return `Rp${number.toLocaleString('id-ID')}`;
    }

    // Fungsi untuk generate ID transaksi
    function generateTransactionId(length) {
      return `TRX${String(length + 1).padStart(3, '0')}`;
    }

    // Fungsi untuk mengambil data penjualan dari backend
    async function fetchSales() {
      try {
        const response = await fetch('https://audit-sijablay-be.vercel.app/api/sales');
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        console.log('Data penjualan dari backend:', data);
        return data;
      } catch (error) {
        console.error('Error fetching sales:', error);
        alert('Gagal mengambil data penjualan. Pastikan server berjalan.');
        return [];
      }
    }

    // Fungsi untuk mengambil data stok dari backend
    async function fetchStock() {
      try {
        const response = await fetch('https://audit-sijablay-be.vercel.app/api/stock');
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        console.log('Data stok dari backend:', data);
        return data;
      } catch (error) {
        console.error('Error fetching stock:', error);
        alert('Gagal mengambil data stok. Pastikan server berjalan.');
        return [];
      }
    }

    // Fungsi untuk filter data berdasarkan semua kriteria
    function applyFilters(sales) {
      let filteredData = Array.isArray(sales) ? [...sales] : [];

      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const paymentStatus = document.getElementById('paymentStatusFilter').value;
      const branchFilter = document.getElementById('branchFilter').value;
      const searchQuery = document.getElementById('search').value.toUpperCase();

      if (startDate && endDate && startDate > endDate) {
        alert('Tanggal Mulai harus sebelum Tanggal Akhir.');
        return filteredData;
      }

      if (startDate) filteredData = filteredData.filter(item => item.date >= startDate);
      if (endDate) filteredData = filteredData.filter(item => item.date <= endDate);
      if (paymentStatus !== 'all') filteredData = filteredData.filter(item => item.paymentStatus === paymentStatus);
      if (branchFilter !== 'all') filteredData = filteredData.filter(item => item.branch === branchFilter);
      if (searchQuery) filteredData = filteredData.filter(item => item.id.includes(searchQuery));

      // Pastikan filteredData adalah array sebelum slice
      if (Array.isArray(filteredData) && currentLimit !== 'all') {
        filteredData = filteredData.slice(-currentLimit);
      }

      return filteredData;
    }

    // Fungsi untuk mengelompokkan produk per tanggal untuk tooltip
    function getProductDetails(data, date) {
      const items = data.filter(item => item.date === date);
      if (items.length === 0) return 'Tidak ada detail produk';
      const listItems = items.map(item => `<li>${item.product}: ${item.quantity} unit(s) - Status Pembayaran: ${item.paymentStatus} - Cabang: ${item.branch}</li>`).join('');
      return `<ul>${listItems}</ul>`;
    }

    // Fungsi untuk render tabel
    function renderTable(data) {
      const tbody = document.getElementById('salesTableBody');
      const noDataMessage = document.getElementById('noDataMessage');
      tbody.innerHTML = '';

      const sortedData = sortData(data, currentSortColumn, currentSortDirection);

      if (sortedData.length === 0) {
        noDataMessage.classList.remove('hidden');
      } else {
        noDataMessage.classList.add('hidden');
        sortedData.forEach(item => {
          const rowClass = item.paymentStatus === 'Lunas' ? 'bg-green-200' : 
                          item.paymentStatus === 'Belum Lunas' ? 'bg-red-200' : '';
          const row = document.createElement('tr');
          row.className = rowClass;
          row.innerHTML = `
            <td class="p-3">${item.date}</td>
            <td class="p-3">${item.id}</td>
            <td class="p-3">${item.product}</td>
            <td class="p-3">${item.branch}</td>
            <td class="p-3">${item.quantity}</td>
            <td class="p-3">${formatRupiah(item.unitPrice)}</td>
            <td class="p-3">${formatRupiah(item.total)}</td>
            <td class="p-3">${item.paymentMethod}</td>
            <td class="p-3">${item.status}</td>
            <td class="p-3">${item.saleType || 'Tidak Diketahui'}</td>
            <td class="p-3">${item.paymentStatus || 'Tidak Diketahui'}</td>
            <td class="p-3">
              <button class="editBtn bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 mr-2" data-id="${item.id}">Edit</button>
              <button class="deleteBtn bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600" data-id="${item.id}">Hapus</button>
            </td>
          `;
          if (item.description) {
            const descRow = document.createElement('tr');
            descRow.className = rowClass;
            descRow.innerHTML = `
              <td colspan="12" class="p-3 pl-6 text-gray-600">
                • ${item.description}
              </td>
            `;
            tbody.appendChild(row);
            tbody.appendChild(descRow);
          } else {
            tbody.appendChild(row);
          }
        });
      }

      const total = sortedData.reduce((sum, item) => sum + (item.total || 0), 0);
      const totalPaid = sortedData.filter(item => item.paymentStatus === 'Lunas').reduce((sum, item) => sum + (item.total || 0), 0);
      const totalUnpaid = sortedData.filter(item => item.paymentStatus === 'Belum Lunas').reduce((sum, item) => sum + (item.total || 0), 0);
      const totalATM = sortedData.filter(item => item.paymentMethod === 'Transfer Bank').reduce((sum, item) => sum + (item.total || 0), 0);
      const totalCash = sortedData.filter(item => item.paymentMethod === 'Cash').reduce((sum, item) => sum + (item.total || 0), 0);
      const unpaidATM = sortedData.filter(item => item.paymentMethod === 'Transfer Bank' && item.paymentStatus === 'Belum Lunas').reduce((sum, item) => sum + (item.total || 0), 0);
      const unpaidCash = sortedData.filter(item => item.paymentMethod === 'Cash' && item.paymentStatus === 'Belum Lunas').reduce((sum, item) => sum + (item.total || 0), 0);

      document.getElementById('totalSales').textContent = `Total Penjualan: ${formatRupiah(total)}`;
      document.getElementById('totalPaid').textContent = `Total Lunas: ${formatRupiah(totalPaid)}`;
      document.getElementById('totalUnpaid').textContent = `Total Belum Lunas: ${formatRupiah(totalUnpaid)}`;
      document.getElementById('totalATM').textContent = `Total Uang di ATM: ${formatRupiah(totalATM)}`;
      document.getElementById('totalCash').textContent = `Total Uang di Cash: ${formatRupiah(totalCash)}`;
      document.getElementById('anomaly').textContent = '';
    }

    // Fungsi untuk update grafik
    function updateCharts(data) {
      const dates = [...new Set(data.map(item => item.date))].sort();

      const totals = dates.map(date => data.filter(item => item.date === date).reduce((sum, item) => sum + (item.total || 0), 0));
      const quantities = dates.map(date => data.filter(item => item.date === date).reduce((sum, item) => sum + (item.quantity || 0), 0));

      if (salesChart && !isSalesChartMinimized) {
        salesChart.destroy();
        const salesCtx = document.getElementById('salesChart').getContext('2d');
        salesChart = new Chart(salesCtx, {
          type: 'bar',
          data: {
            labels: dates,
            datasets: [{
              label: 'Total Penjualan (Rp)',
              data: totals,
              backgroundColor: 'rgba(59, 130, 246, 0.5)',
              borderColor: 'rgba(59, 130, 246, 1)',
              borderWidth: 1
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                ticks: { callback: value => formatRupiah(value) }
              }
            }
          }
        });
      }

      if (quantityChart && !isQuantityChartMinimized) {
        quantityChart.destroy();
        const quantityCtx = document.getElementById('quantityChart').getContext('2d');
        quantityChart = new Chart(quantityCtx, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [{
              label: 'Total Barang Keluar',
              data: quantities,
              fill: false,
              borderColor: 'rgba(255, 99, 132, 1)',
              tension: 0.1
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1 }
              }
            },
            plugins: {
              tooltip: {
                enabled: false,
                external: function(context) {
                  const { chart, tooltip } = context;

                  if (!tooltipEl) {
                    console.error('Tooltip element not found or not created.');
                    return;
                  }

                  if (tooltip.opacity === 0) {
                    tooltipEl.style.opacity = '0';
                    return;
                  }

                  if (!tooltip.dataPoints || tooltip.dataPoints.length === 0) {
                    console.warn('No tooltip data points available:', tooltip);
                    tooltipEl.innerHTML = '<div><p>Tidak ada data untuk ditampilkan</p></div>';
                  } else {
                    const date = tooltip.dataPoints[0].label;
                    console.log('Tooltip triggered for date:', date, 'with data:', tooltip.dataPoints[0]);
                    const details = getProductDetails(data, date);
                    tooltipEl.innerHTML = `
                      <div>
                        <p>Total Barang: ${tooltip.dataPoints[0].raw} unit(s)</p>
                        <p>Detail Produk:</p>
                        ${details}
                      </div>
                    `;
                  }

                  const position = chart.canvas.getBoundingClientRect();
                  const leftPosition = position.left + tooltip.caretX;
                  const topPosition = position.top + window.scrollY + tooltip.caretY + 10;
                  tooltipEl.style.left = leftPosition + 'px';
                  tooltipEl.style.top = topPosition + 'px';
                  tooltipEl.style.opacity = '1';
                }
              }
            }
          }
        });
      }
    }

    // Fungsi untuk update harga berdasarkan tipe penjualan dan produk
    function updatePrice(isEdit = false) {
      const productSelect = isEdit ? document.getElementById('editProduct') : document.getElementById('product');
      const saleTypeSelect = isEdit ? document.getElementById('editSaleType') : document.getElementById('saleType');
      const unitPriceInput = isEdit ? document.getElementById('editUnitPrice') : document.getElementById('unitPrice');
      const selected = productSelect.options[productSelect.selectedIndex];
      if (selected.value) {
        const price = saleTypeSelect.value === 'reseller' ? selected.getAttribute('data-reseller') : selected.getAttribute('data-price');
        unitPriceInput.value = price || '';
      }
    }

    // Fungsi untuk konversi data ke CSV dengan format baris terpisah
    function convertToCSV(data) {
      const rows = [];

      data.forEach((item, index) => {
        if (index > 0) {
          rows.push('');
        }
        rows.push(`Transaksi ${index + 1}`);
        rows.push(`Tanggal: ${item.date}`);
        rows.push(`ID Transaksi: ${item.id}`);
        rows.push(`Produk: ${item.product}`);
        rows.push(`Cabang: ${item.branch}`);
        rows.push(`Jumlah: ${item.quantity}`);
        rows.push(`Harga Satuan: ${formatRupiah(item.unitPrice)}`);
        rows.push(`Total: ${formatRupiah(item.total)}`);
        rows.push(`Metode Pembayaran: ${item.paymentMethod}`);
        rows.push(`Status: ${item.status}`);
        rows.push(`Tipe Penjualan: ${item.saleType || 'Tidak Diketahui'}`);
        rows.push(`Status Pembayaran: ${item.paymentStatus || 'Tidak Diketahui'}`);
        if (item.description) {
          rows.push(`Deskripsi: ${item.description}`);
        }
      });

      const totalATM = data.filter(item => item.paymentMethod === 'Transfer Bank').reduce((sum, item) => sum + (item.total || 0), 0);
      const totalCash = data.filter(item => item.paymentMethod === 'Cash').reduce((sum, item) => sum + (item.total || 0), 0);
      const unpaidATM = data.filter(item => item.paymentMethod === 'Transfer Bank' && item.paymentStatus === 'Belum Lunas').reduce((sum, item) => sum + (item.total || 0), 0);
      const unpaidCash = data.filter(item => item.paymentMethod === 'Cash' && item.paymentStatus === 'Belum Lunas').reduce((sum, item) => sum + (item.total || 0), 0);

      rows.push('');
      rows.push('Ringkasan');
      rows.push(`Total Uang di ATM: ${formatRupiah(totalATM)}`);
      rows.push(`Total Uang di Cash: ${formatRupiah(totalCash)}`);
      rows.push(`Total Belum Lunas di ATM: ${formatRupiah(unpaidATM)}`);
      rows.push(`Total Belum Lunas di Cash: ${formatRupiah(unpaidCash)}`);

      return rows.join('\n');
    }

    // Fungsi untuk ekspor ke CSV
    async function exportToCSV() {
      const sales = await fetchSales();
      const filteredData = applyFilters(sales);

      const csvContent = convertToCSV(filteredData);
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      const currentDate = new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }).replace(/[:/]/g, '-').replace(/,\s+/g, '_');
      link.setAttribute('href', url);
      link.setAttribute('download', `penjualan_${currentDate}.csv`);
      link.click();
    }

    // Event listener untuk form utama
    document.getElementById('product').addEventListener('change', () => updatePrice(false));
    document.getElementById('saleType').addEventListener('change', () => updatePrice(false));

    // Event listener untuk form edit
    document.getElementById('editProduct').addEventListener('change', () => updatePrice(true));
    document.getElementById('editSaleType').addEventListener('change', () => updatePrice(true));

    // Handle submit formulir tambah dengan validasi stok
    document.getElementById('salesForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const date = document.getElementById('date').value;
      const saleType = document.getElementById('saleType').value;
      const productSelect = document.getElementById('product');
      const product = productSelect.options[productSelect.selectedIndex].text;
      const branch = document.getElementById('branch').value;
      const unitPrice = parseFloat(document.getElementById('unitPrice').value);
      const quantity = parseInt(document.getElementById('quantity').value);
      const paymentMethod = document.getElementById('paymentMethod').value;
      const paymentStatus = document.getElementById('paymentStatus').value;
      const description = document.getElementById('description').value;

      const stock = await fetchStock();
      const stockItem = stock.find(item => item.product === product && item.branch === branch);
      if (!stockItem || stockItem.quantity < quantity) {
        alert(`Stok tidak mencukupi untuk ${product} di cabang ${branch}. Stok tersedia: ${stockItem ? stockItem.quantity : 0} unit.`);
        return;
      }

      const total = quantity * unitPrice;

      const sales = await fetchSales();
      const newSale = {
        date,
        product,
        branch,
        quantity,
        unitPrice,
        total,
        paymentMethod,
        status: "Selesai",
        saleType,
        paymentStatus,
        description
      };

      console.log('Data penjualan yang akan dikirim:', newSale);

      try {
        const salesResponse = await fetch('https://audit-sijablay-be.vercel.app/api/sales', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newSale)
        });
        if (!salesResponse.ok) {
          const errorData = await salesResponse.json();
          throw new Error(errorData.error || `HTTP error! Status: ${salesResponse.status}`);
        }
        const salesResult = await salesResponse.json();
        console.log('Respons dari backend (penjualan):', salesResult);
      } catch (error) {
        console.error('Error saat mengirim data:', error);
        alert(`Gagal menambahkan transaksi: ${error.message}`);
        return;
      }

      const updatedSales = await fetchSales();
      const filteredData = applyFilters(updatedSales);
      renderTable(filteredData);
      this.reset();
      document.getElementById('unitPrice').value = '';
    });

    // Handle edit
    document.addEventListener('click', async function(e) {
      if (e.target.classList.contains('editBtn')) {
        const id = e.target.dataset.id;
        const sales = await fetchSales();
        const sale = sales.find(item => item.id === id);

        document.getElementById('editId').value = sale.id;
        document.getElementById('editDate').value = sale.date;
        document.getElementById('editSaleType').value = sale.saleType || 'onhand';
        document.getElementById('editProduct').value = sale.product;
        document.getElementById('editBranch').value = sale.branch;
        document.getElementById('editQuantity').value = sale.quantity;
        document.getElementById('editPaymentMethod').value = sale.paymentMethod;
        document.getElementById('editStatus').value = sale.status;
        document.getElementById('editPaymentStatus').value = sale.paymentStatus || 'Lunas';
        document.getElementById('editDescription').value = sale.description || '';

        updatePrice(true);

        document.getElementById('editModal').classList.remove('hidden');
      }

      if (e.target.classList.contains('deleteBtn')) {
        if (confirm('Yakin ingin menghapus transaksi ini?')) {
          const id = e.target.dataset.id;
          try {
            const response = await fetch(`https://audit-sijablay-be.vercel.app/api/sales/${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

            const updatedSales = await fetchSales();
            const filteredData = applyFilters(updatedSales);
            renderTable(filteredData);
          } catch (error) {
            console.error('Error saat menghapus:', error);
            alert('Gagal menghapus transaksi.');
          }
        }
      }
    });

    // Handle submit edit
    document.getElementById('editForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const id = document.getElementById('editId').value;
      const date = document.getElementById('editDate').value;
      const saleType = document.getElementById('editSaleType').value;
      const product = document.getElementById('editProduct').value;
      const branch = document.getElementById('editBranch').value;
      const quantity = parseInt(document.getElementById('editQuantity').value);
      const unitPrice = parseFloat(document.getElementById('editUnitPrice').value);
      const paymentMethod = document.getElementById('editPaymentMethod').value;
      const status = document.getElementById('editStatus').value;
      const paymentStatus = document.getElementById('editPaymentStatus').value;
      const description = document.getElementById('editDescription').value;

      const sales = await fetchSales();
      const originalSale = sales.find(item => item.id === id);
      const stock = await fetchStock();
      const stockItem = stock.find(item => item.product === product && item.branch === branch);

      const quantityDifference = quantity - originalSale.quantity;

      if (quantityDifference > 0 && (!stockItem || stockItem.quantity < quantityDifference)) {
        alert(`Stok tidak mencukupi untuk ${product} di cabang ${branch}. Stok tersedia: ${stockItem ? stockItem.quantity : 0} unit.`);
        return;
      }

      const total = quantity * unitPrice;

      const updatedSale = {
        date,
        product,
        branch,
        quantity,
        unitPrice,
        total,
        paymentMethod,
        status,
        saleType,
        paymentStatus,
        description
      };

      console.log('Data edit yang akan dikirim:', updatedSale);

      try {
        const response = await fetch(`https://audit-sijablay-be.vercel.app/api/sales/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedSale)
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
        }

        const updatedSales = await fetchSales();
        const filteredData = applyFilters(updatedSales);
        renderTable(filteredData);
        document.getElementById('editModal').classList.add('hidden');
      } catch (error) {
        console.error('Error saat mengedit:', error);
        alert(`Gagal mengedit transaksi: ${error.message}`);
      }
    });

    // Handle batal edit
    document.getElementById('cancelEdit').addEventListener('click', function() {
      document.getElementById('editModal').classList.add('hidden');
    });

    // Filter berdasarkan rentang tanggal
    document.getElementById('startDate').addEventListener('change', async function() {
      const sales = await fetchSales();
      const filteredData = applyFilters(sales);
      renderTable(filteredData);
    });

    document.getElementById('endDate').addEventListener('change', async function() {
      const sales = await fetchSales();
      const filteredData = applyFilters(sales);
      renderTable(filteredData);
    });

    // Filter berdasarkan status pembayaran
    document.getElementById('paymentStatusFilter').addEventListener('change', async function() {
      const sales = await fetchSales();
      const filteredData = applyFilters(sales);
      renderTable(filteredData);
    });

    // Filter berdasarkan cabang
    document.getElementById('branchFilter').addEventListener('change', async function() {
      const sales = await fetchSales();
      const filteredData = applyFilters(sales);
      renderTable(filteredData);
    });

    // Pencarian berdasarkan ID Transaksi
    document.getElementById('search').addEventListener('input', async function() {
      const sales = await fetchSales();
      const filteredData = applyFilters(sales);
      renderTable(filteredData);
    });

    // Filter berdasarkan jumlah transaksi
    document.querySelectorAll('.limit-btn').forEach(button => {
      button.addEventListener('click', async function() {
        const limit = this.dataset.limit;
        currentLimit = limit === 'all' ? 'all' : parseInt(limit);
        setActiveLimitButton(limit);

        const sales = await fetchSales();
        const filteredData = applyFilters(sales);
        renderTable(filteredData);
      });
    });

    // Toggle grafik
    document.getElementById('toggleSalesChart').addEventListener('click', function() {
      isSalesChartMinimized = !isSalesChartMinimized;
      const container = document.getElementById('salesChartContainer');
      container.classList.toggle('minimized');
      this.textContent = isSalesChartMinimized ? '+' : '-';
      if (!isSalesChartMinimized) {
        const sales = fetchSales();
        const filteredData = applyFilters(sales);
        updateCharts(filteredData);
      }
    });

    document.getElementById('toggleQuantityChart').addEventListener('click', function() {
      isQuantityChartMinimized = !isQuantityChartMinimized;
      const container = document.getElementById('quantityChartContainer');
      container.classList.toggle('minimized');
      this.textContent = isQuantityChartMinimized ? '+' : '-';
      if (!isQuantityChartMinimized) {
        const sales = fetchSales();
        const filteredData = applyFilters(sales);
        updateCharts(filteredData);
      }
    });

    // Reset semua filter
    document.getElementById('resetFilter').addEventListener('click', async function() {
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('paymentStatusFilter').value = 'all';
      document.getElementById('branchFilter').value = 'all';
      document.getElementById('search').value = '';
      currentLimit = 10;
      setActiveLimitButton(currentLimit);

      const sales = await fetchSales();
      const filteredData = applyFilters(sales);
      renderTable(filteredData);
    });

    // Event listener untuk sorting
    document.querySelectorAll('th[data-column]').forEach(header => {
      header.addEventListener('click', async () => {
        const column = header.dataset.column;
        const currentDirection = header.dataset.sort;
        const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';

        currentSortColumn = column;
        currentSortDirection = newDirection;

        header.dataset.sort = newDirection;

        document.querySelectorAll('th[data-column]').forEach(h => {
          if (h !== header) {
            h.dataset.sort = 'asc';
          }
        });

        const sales = await fetchSales();
        const filteredData = applyFilters(sales);
        renderTable(filteredData);
      });
    });

    // Event listener untuk ekspor ke CSV
    document.getElementById('exportCSV').addEventListener('click', async () => {
      await exportToCSV();
    });

    // Inisialisasi
    async function init() {
      const sales = await fetchSales();
      const filteredData = applyFilters(sales);
      renderTable(filteredData);
      setActiveLimitButton(currentLimit);
      // Grafik dimuat hanya jika tidak diminimalkan
      if (!isSalesChartMinimized) {
        updateCharts(filteredData);
      }
      if (!isQuantityChartMinimized) {
        updateCharts(filteredData);
      }
    }
    init();
  </script>
</body>
</html>